window.selectItems = {
    'question-contact-info-icon-type' :initSelect.getTcpaMessages(),

    'question-contact-info-message' :[
        {
            id:0,
            text:'<div class="select2_style"><span class="select2js-placeholder">Select message:</span><span>Default Message</span></div>',
            title:'Message'
        },
        {
            id:1,
            text:'<div class="select2_style"><span class="select2js-placeholder">Select message:</span><span>Default Message</span></div>',
            title:'Message'
        },
        {
            id:2,
            text:'<div class="select2_style"><span class="select2js-placeholder">Select message:</span><span>Default Message</span></div>',
            title:'Message'
        }
    ],

    'input-type-step1' :[
        {
            id:0,
            text:'<div class="select2_style">Input Type</div>',
            title:'Input Type'
        },
        {
            id:1,
            text:'<div class="select2_style"><span class="select2js-placeholder">Input Type:</span><span>Name</span></div>',
            title:'Input Type Name'
        },
        {
            id:2,
            text:'<div class="select2_style"><span class="select2js-placeholder">Input Type:</span><span>Email</span></div>',
            title:'Input Type Email'
        },
        {
            id:3,
            text:'<div class="select2_style"><span class="select2js-placeholder">Input Type:</span><span>Phone</span></div>',
            title:'Input Type Phone '
        }
    ],

    'contact-variation-step1' :[
        {
            id:0,
            text:'<div class="select2_style">Variation</div>',
            title:'Variation'
        },
        {
            id:1,
            text:'<div class="select2_style"><span class="select2js-placeholder">Variation:</span><span>First Name</span></div>',
            title:'Variation First Name'
        },
        {
            id:2,
            text:'<div class="select2_style"><span class="select2js-placeholder">Variation:</span><span>First Name + Last Name</span></div>',
            title:'Variation First Name + Last Name'
        },
        {
            id:3,
            text:'<div class="select2_style"><span class="select2js-placeholder">Variation:</span><span>Full Name</span></div>',
            title:'Variation Full Name'
        }
    ],

    'input-type1-step1' :[
        {
            id:0,
            text:'<div class="select2_style">Input Type</div>',
            title:'Input Type'
        },
        {
            id:1,
            text:'<div class="select2_style"><span class="select2js-placeholder">Input Type:</span><span>Name</span></div>',
            title:'Input Type Name'
        },
        {
            id:2,
            text:'<div class="select2_style"><span class="select2js-placeholder">Input Type:</span><span>Email</span></div>',
            title:'Input Type Email'
        },
        {
            id:3,
            text:'<div class="select2_style"><span class="select2js-placeholder">Input Type:</span><span>Phone</span></div>',
            title:'Input Type Phone '
        }
    ],

    'input-type2-step1' :[
        {
            id:0,
            text:'<div class="select2_style">Input Type</div>',
            title:'Input Type'
        },
        {
            id:1,
            text:'<div class="select2_style"><span class="select2js-placeholder">Input Type:</span><span>Name</span></div>',
            title:'Input Type Name'
        },
        {
            id:2,
            text:'<div class="select2_style"><span class="select2js-placeholder">Input Type:</span><span>Email</span></div>',
            title:'Input Type Email'
        },
        {
            id:3,
            text:'<div class="select2_style"><span class="select2js-placeholder">Input Type:</span><span>Phone</span></div>',
            title:'Input Type Phone '
        }
    ],

    'country-code' :[
        {
            id:-1,
            text:'<div class="select2_style">Country Code</div>',
            title:'Country Code'
        },
        {
            id:0,
            text:'<div class="select2_style"><span class="select2js-placeholder">Country Code:</span><span>Off</span></div>',
            title:'Country Code Off'
        },
        {
            id:1,
            text:'<div class="select2_style"><span class="select2js-placeholder">Country Code:</span><span>On</span></div>',
            title:'Country Code On'
        }
    ],

    'phone-format' :[
        {
            id:-1,
            text:'<div class="select2_style">Auto-Format Phone Number</div>',
            title:'Auto-Format Phone Number'
        },
        {
            id:0,
            text:'<div class="select2_style"><span class="select2js-placeholder">Auto-Format Phone Number:</span><span>None</span></div>',
            title:'Auto-Format Phone Number None'
        },
        {
            id:1,
            text:'<div class="select2_style"><span class="select2js-placeholder">Auto-Format Phone Number:</span><span>Yes</span></div>',
            title:'Auto-Format Phone Number Yes'
        }
    ],

    'edit-content-step2' :[
        {
            id:0,
            text:'<div class="select2_style">Edit Content For</div>',
            title:'Edit Content For'
        },
        {
            id:1,
            text:'<div class="select2_style"><span class="select2js-placeholder">Edit Content For:</span><span>First Step</span></div>',
            title:'Edit Content For First Step'
        },
        {
            id:2,
            text:'<div class="select2_style"><span class="select2js-placeholder">Edit Content For:</span><span>Second Step</span></div>',
            title:'Edit Content For Second Step'
        },
        {
            id:3,
            text:'<div class="select2_style"><span class="select2js-placeholder">Edit Content For:</span><span>Third Step</span></div>',
            title:'Edit Content For Third Step'
        }
    ],

    'update-phone-format' : [
        {
            'country-code' : [
                {
                    '0' :[
                        {
                            'phone-format' :[
                                {
                                    '0' : 'XXXXXXXXXX',
                                    '1' : '(XXX) XXX-XXXX'
                                },
                            ],
                        }
                    ],
                    '1' : [
                        {
                            'phone-format' :[
                                {
                                    '0' : '+1XXXXXXXXXX',
                                    '1' : '+1 (XXX) XXX-XXXX'
                                },
                            ],
                        }
                    ],
                }
            ],
        }
    ],

};

window.type_select = ['input-type-step2', 'input-type-step3'];
window.type1_select = ['input-type1-step2', 'input-type1-step3'];
window.type2_select = ['input-type2-step2', 'input-type2-step3'];
window.variation_select = ['contact-variation-step2', 'contact-variation-step3'];
window.icon_poistion_select = ['question-contact-info-icon-type-step2', 'question-contact-info-icon-type-step3'];
window.message_select = ['question-contact-info-message-step2', 'question-contact-info-message-step3'];

var dropdown_old_value = '';
var trigger_old_value = '';

var contact_info_overlay = {
    stopChangeNameVariation: false,
    stopDropdown2: false,
    stopDropdown3: false,
    step_val: {
        1: "one",
        2: "two",
        3: "three"
    },
    overlay_select_list : [
        {selecter:".question-contact-info-icon-type", parent:".question-contact-info-input-icon-parent"},
        {selecter:".question-contact-info-message", parent:".question-contact-info-message-parent"},
        {selecter:".question-contact-info-icon-type-step2", parent:".question-contact-info-input-icon-parent-step2"},
        {selecter:".question-contact-info-message-step2", parent:".question-contact-info-message-parent-step2"},
        {selecter:".question-contact-info-icon-type-step3", parent:".question-contact-info-input-icon-parent-step3"},
        {selecter:".question-contact-info-message-step3", parent:".question-contact-info-message-parent-step3"},
        {selecter:".input-type-step1", parent:".input-type-step1-parent"},
        {selecter:".contact-variation-step1", parent:".contact-variation-step1-parent"},
        {selecter:".input-type1-step1", parent:".input-type1-step1-parent"},
        {selecter:".input-type2-step1", parent:".input-type2-step1-parent"},
        {selecter:".country-code", parent:".advance-country-code-parent"},
        {selecter:".phone-format", parent:".advance-phone-format-parent"},
//{selecter:".edit-content-step2", parent:".edit-content-step2-parent"},
        {selecter:".input-type-step2", parent:".input-type-step2-parent"},
        {selecter:".contact-variation-step2", parent:".contact-variation-step2-parent"},
        {selecter:".input-type1-step2", parent:".input-type1-step2-parent"},
        {selecter:".input-type2-step2", parent:".input-type2-step2-parent"},
        {selecter:".input-type-step3", parent:".input-type-step3-parent"},
        {selecter:".contact-variation-step3", parent:".contact-variation-step3-parent"},
        {selecter:".input-type1-step3", parent:".input-type1-step3-parent"},
        {selecter:".input-type2-step3", parent:".input-type2-step3-parent"},
        {selecter:".edit-content-step3", parent:".edit-content-step3-parent"},
    ],

    /**
     * Custom select loop
     * @param exclude
     */
    allCustomSelect: function (exclude) {
        var selectlist = contact_info_overlay.overlay_select_list;
        for(var i = 0; i < selectlist.length; i++) {
            if (selectlist[i].selecter !== exclude) {
                contact_info_overlay.initCustomSelect(selectlist[i].selecter, selectlist[i].parent);
            }
        }
        SaveContactPreviewChanges.contactFormPopulateData();
        SaveContactPreviewChanges.hideShowUniqueVariableRequiredFields();
        SaveContactPreviewChanges.showHideRequiredCheckbox();
    },

    /*
    ** init custom select
    **/

    initCustomSelect: function (selecter,parent, newData=null) {
        var amIclosing = false;
        var _selector = jQuery(selecter);
        var _parent = jQuery(parent);
        var selectorClass = selecter.replace(/[#.]/g,'');
        if(jQuery.inArray(selectorClass, type_select) !== -1 ) {
            selectorClass = 'input-type-step1';
        }
        if(jQuery.inArray(selectorClass, type1_select) !== -1 ) {
            selectorClass = 'input-type1-step1';
        }
        if(jQuery.inArray(selectorClass, type2_select) !== -1 ) {
            selectorClass = 'input-type2-step1';
        }
        if(jQuery.inArray(selectorClass, variation_select) !== -1 ) {
            selectorClass = 'contact-variation-step1';
        }
        if(jQuery.inArray(selectorClass, icon_poistion_select) !== -1 ) {
            selectorClass = 'question-contact-info-icon-type';
        }
        if(jQuery.inArray(selectorClass, message_select) !== -1 ) {
            selectorClass = 'question-contact-info-message';
        }
        if(selectorClass == 'edit-content-step3'){
            selectorClass = 'edit-content-step2';
        }
        _selector.select2({
            data: newData === null ? selectItems[selectorClass] : newData,
            minimumResultsForSearch: -1,
            dropdownParent: jQuery(parent),
            width: '100%',
            templateResult: function (d) {
                return $(d.text);
            },
            templateSelection: function (d) {
                return $(d.text);
            }

            /*
            ** Triggered before the drop-down is opened.
            */
        }).on('select2:opening', function() {
            _parent.find('.select2-selection__rendered').css('opacity', '0');

            /*
            ** Triggered whenever the drop-down is opened.
            ** select2:opening is fired before this and can be prevented.
            */

        }).on('select2:open', function() {
            var _selectoptions = _parent.find('.select2-results__options');
            var _selectdropdown = _parent.find('.select2-dropdown');
                dropdown_old_value = $(this).val();
            _selectoptions.css('pointer-events', 'none');

            setTimeout(function() {
                _selectoptions.css('pointer-events', 'auto');
            }, 300);

            _selectdropdown.hide();
            _selectdropdown.css({'display': 'block', 'opacity': '1', 'transform': 'scale(1, 1)'});
            _parent.find('.select2-selection__rendered').hide();
            lpUtilities.niceScroll();
            setTimeout(function () {
                _parent.find('.select2-dropdown .nicescroll-rails-vr').each(function () {
                    this.style.setProperty( 'opacity', '1', 'important' );
                    var getindex = _selector.find(':selected').index();
                    var defaultHeight = 44;
                    var scrolledArea = getindex * defaultHeight;
                    $(".select2-results__options").getNiceScroll(0).doScrollTop(scrolledArea);
                    this.style.setProperty( 'opacity', '1', 'important' );
                });
            }, 100);

            /*
            ** Triggered before the drop-down is closed.
            */

        }).on('select2:closing', function(e) {
            if(!amIclosing) {
                e.preventDefault();
                amIclosing = true;

                _parent.find('.select2-dropdown').attr('style', '');

                setTimeout(function () {
                    _selector.select2("close");
                }, 200);
            } else {
                amIclosing = false;
            }

            /*
            ** Triggered whenever the drop-down is closed.
            ** select2:closing is fired before this and can be prevented.
            */

        }).on('select2:close', function() {
            _parent.find('.select2-selection__rendered').show();
            _parent.find('.select2-selection__rendered').css('opacity', '1');
            _parent.find('.select2-results__options').css('pointer-events', 'none');
        });

        if (selectorClass == 'edit-content-step2') {
            _selector.on('change', function () {
                let useSelector;

                $('[data-contact-nav-id]').each(function() {
                    if ($(this).hasClass('active')) {
                        useSelector = $(this).data('contact-nav-id');
                    }
                });
                $('[data-id="active_slide"]').val(this.value-1);
                let main_button_disabled = $('[data-id="main-submit"]').is(":disabled")
                SaveContactPreviewChanges.loadContactForm();
                if(main_button_disabled == false)
                {
                    $('[data-id="main-submit"]').attr("disabled",false);
                }
                if($('.fb-tab__link.step-3').hasClass('active'))
                {
                    SaveContactPreviewChanges.disableAddButtonStep3();
                }
                else if($('.fb-tab__link.step-2').hasClass('active'))
                {
                    SaveContactPreviewChanges.disableAddButtonStep2();
                }
            });
        }

        if (selectorClass == 'input-type-step1') {
//$(selecter).val(1).change();
            $(selecter).val(trigger_old_value??1).trigger('change.select2');
            contact_info_overlay.inputTypeShowHide(trigger_old_value??1, 1);
            _selector.on('change', function (e) {
                var $this = $(this).val();
                if(!$('.fb-tab__link.step-1').hasClass('active'))
                {
                    SaveContactPreviewChanges.updateDropdownOtherSteps(selectorClass,dropdown_old_value,this.value,1);
                }
                if (contact_info_overlay.stopChangeNameVariation === false) {
                    if (newData === null) {
                        SaveContactPreviewChanges.updateDropdowns(selectorClass, this.value);
                    }
                    if (SaveContactPreviewChanges.getActiveDropdowns() < 3) {
                        if(site.env_production.toLowerCase() == "local") console.info('sending saveContactForm call dropdown 1');
                        SaveContactPreviewChanges.saveContactForm(this.value, 'name-email-phone', 1);
                    } else {
                        if (SaveContactPreviewChanges.organizeSorting === false) {
                            SaveContactPreviewChanges.sortingSequence();
                        }
                        SaveChangesPreview.updateQuickAccessLinks();
                    }
                }
                contact_info_overlay.inputTypeShowHide(this.value, 1);
            });
        }

        if (selectorClass == 'contact-variation-step1') {
            $(selecter).val(3).change();
            _selector.on('change', function () {
                if (contact_info_overlay.stopChangeNameVariation === false) {
                    let step = selecter.replace('.contact-variation-step', '');
                    if(site.env_production.toLowerCase() == "local") console.info('contact-variation-step', step);
                    contact_info_overlay.nameVariationShowHide(step);
                    var $this = $(this).val();
                    SaveContactPreviewChanges.saveContactForm(this.value, 'name-variation', step);
                }
            });
        }

        if (selectorClass == 'input-type1-step1') {
            let setVal = newData === null ? 2 : newData[1]['id'];
//$(selecter).val(setVal).change();
            $(selecter).val(trigger_old_value??setVal).trigger('change.select2');
            contact_info_overlay.inputTypeShowHide(trigger_old_value??setVal, 2);
            _selector.on('change', function (e) {
                var $this = $(this).val();
                    if (!$('.fb-tab__link.step-1').hasClass('active')) {
                        SaveContactPreviewChanges.updateDropdownOtherSteps(selectorClass, dropdown_old_value, this.value, 2);
                    }
                    if (contact_info_overlay.stopDropdown2 === false) {
                        if (newData === null) {
                            SaveContactPreviewChanges.updateDropdowns(selectorClass, this.value);
                        }
                        contact_info_overlay.stopDropdown2 = true;
                        if (SaveContactPreviewChanges.getActiveDropdowns() < 3 && SaveContactPreviewChanges.isHideDropdown(2) === false) {
                            if (site.env_production.toLowerCase() == "local") console.info('sending saveContactForm call dropdown 2');
                            SaveContactPreviewChanges.saveContactForm(this.value, 'name-email-phone', 2);
                        } else {
                            if (SaveContactPreviewChanges.organizeSorting === false) {
                                SaveContactPreviewChanges.sortingSequence();
                            }
                            SaveChangesPreview.updateQuickAccessLinks();
                        }
                        setTimeout(function () {
                            contact_info_overlay.stopDropdown2 = false;
                        }, 1000);
                    }
                    contact_info_overlay.inputTypeShowHide(this.value, 2);

            });
        }

        if (selectorClass == 'input-type2-step1') {
            let setVal = newData === null ? 3 : newData[1]['id'];
//$(selecter).val(setVal).change();
            $(selecter).val(trigger_old_value??setVal).trigger('change.select2');
            contact_info_overlay.inputTypeShowHide(trigger_old_value??setVal, 3);
            _selector.on('change', function () {
                var $this = $(this).val();

                if(!$('.fb-tab__link.step-1').hasClass('active'))
                {
                    SaveContactPreviewChanges.updateDropdownOtherSteps(selectorClass,dropdown_old_value,this.value,3);
                }
                if (newData === null) {
                    SaveContactPreviewChanges.updateDropdowns(selectorClass, this.value);
                }
                if (contact_info_overlay.stopDropdown3 === false) {
                    if (SaveContactPreviewChanges.getActiveDropdowns() < 3 && SaveContactPreviewChanges.isHideDropdown(3) === false) {
                        if(site.env_production.toLowerCase() == "local") console.info('sending saveContactForm call dropdown 3');
                        contact_info_overlay.stopDropdown3 = true;
                        SaveContactPreviewChanges.saveContactForm(this.value, 'name-email-phone', 3);
                    } else {
                        if (SaveContactPreviewChanges.organizeSorting === false) {
                            SaveContactPreviewChanges.sortingSequence();
                        }
                        SaveChangesPreview.updateQuickAccessLinks();
                    }
                    setTimeout(function () {
                        contact_info_overlay.stopDropdown3 = false;
                    }, 1000);
                }
                contact_info_overlay.inputTypeShowHide(this.value, 3);
            });
        }
    },

    /**
     * Name variation show hide
     * @param step
     */
    nameVariationShowHide: function(step) {
        let value, step_val, selector;
        step_val = contact_info_overlay.step_val[step];
        selector = $('[data-input-'+step_val+'-parent]');
        value = selector.find('.contact-variation-step'+step).val();

        if (contact_info_overlay.stopChangeNameVariation === false) {
            if(site.env_production.toLowerCase() == "local") console.info('nameVariationShowHide1');
            contact_info_overlay.stopChangeNameVariation = true;

// sync values for name variation for input 1, 2 and 3
            if (step == 1) {
                $('.contact-variation-step2').val(value).trigger('change.select2');
                $('.contact-variation-step3').val(value).trigger('change.select2');
            } else if (step == 2) {
                $('.contact-variation-step1').val(value).trigger('change.select2');
                $('.contact-variation-step3').val(value).trigger('change.select2');
            } else if (step == 3) {
                $('.contact-variation-step1').val(value).trigger('change.select2');
                $('.contact-variation-step2').val(value).trigger('change.select2');
            }

            if (value == 1) {
                selector.find(".first-name").css("display", "block");
                selector.find(".last-name").css("display", "none");
                selector.find(".full-name").css("display", "none");
            } else if (value == 2) {
                selector.find(".first-name").css("display", "block");
                selector.find(".last-name").css("display", "block");
                selector.find(".full-name").css("display", "none");
            } else if (value == 3) {
                selector.find(".first-name").css("display", "none");
                selector.find(".last-name").css("display", "none");
                selector.find(".full-name").css("display", "block");
            }

            setTimeout(function () {
                contact_info_overlay.stopChangeNameVariation = false;
            }, 1000);
        }
    },

    /**
     * Show hide name or email or phone fields based on selection
     * @param value
     * @param step
     */
    inputTypeShowHide: function(value, step) {
        let step_val, selector;

        step_val = contact_info_overlay.step_val[step];

        selector = $('[data-input-'+step_val+'-parent]');

        if (value == 1){
            selector.find(".contact-variation-step"+step+"-dropdown").css("display", "block");
            contact_info_overlay.nameVariationShowHide(step);
            selector.find(".number-field").css("display", "none");
            selector.find(".email-field").css("display", "none");
        } else if (value == 2){
            selector.find(".contact-variation-step"+step+"-dropdown").css("display", "none");
            selector.find(".first-name").css("display", "none");
            selector.find(".last-name").css("display", "none");
            selector.find(".full-name").css("display", "none");
            selector.find(".number-field").css("display", "none");
            selector.find(".email-field").css("display", "block");
        } else if (value == 3){
            selector.find(".contact-variation-step"+step+"-dropdown").css("display", "none");
            selector.find(".first-name").css("display", "none");
            selector.find(".last-name").css("display", "none");
            selector.find(".full-name").css("display", "none");
            selector.find(".number-field").css("display", "flex");
            selector.find(".email-field").css("display", "none");
        }
    },

    /*
    ** Open Close Function
    **/

    openclose: function () {

        jQuery('[data-required-opener]').change(function () {
            if(this.checked){
                jQuery(this).closest('[data-required-parent]').find('[data-required-slide]').slideDown();

                    if($('.required-check-list').find('.hide-checkbox-field:checked').length == 0)
                    {
                        $('.required-check-list').find('.hide-checkbox-field:visible').click();
                    }
            }
            else {
                jQuery(this).closest('[data-required-parent]').find('[data-required-slide]').slideUp();
                let required_fields = $('.required-check-list li');
                $.each(required_fields.find('input'),function (el,index){
                    if($(this).attr('checked') !== undefined){
                        $(this).click();
                    }
                })
                if($('#zip-code-showonly-option').prop('checked'))
                {
                    $('#zip-code-showonly-option').click()
                }
                SaveContactPreviewChanges.showHideRequiredCheckbox();
            }
        });

        $('.required-check-list .hide-checkbox-field').on('change',function (){
            if($('.required-check-list').find('.hide-checkbox-field:visible:checked').length > 0)
            {
                $('[data-cta-button]').show();
            }else{
                if($('#zip-code-showonly-option').prop('checked'))
                {
                    $('#zip-code-showonly-option').click()
                }
                $('[data-cta-button]').hide();
            }
        });

        jQuery('[data-change-contact-fields]').on('keyup input paste', FunnelsUtil.debounce(function (event) {
            console.log(event);
            SaveContactPreviewChanges.saveContactTextFields(event);
        }, 500));

        jQuery('.fb-tab__link').click(function(e){
            e.preventDefault();
            jQuery('.fb-tab__link').removeClass('active');
            jQuery(this).addClass('active');
            if(jQuery(this).hasClass('step-2')){
                jQuery('.tab-content').addClass('step2-active').removeClass('step3-active');
                jQuery('.step-field').removeClass('step-parent-active');
                jQuery('.step2-field').addClass('step-parent-active');
            }
            else {
                if(jQuery(this).hasClass('step-3')){
                    jQuery('.tab-content').addClass('step3-active').removeClass('step2-active');
                    if(site.env_production.toLowerCase() == "local") console.info('step3 active');
                    jQuery('.step-field').removeClass('step-parent-active');
                    jQuery('.step3-field').addClass('step-parent-active');
                }
                else {
                    jQuery('.tab-content').removeClass('step2-active step3-active');
                    jQuery('.step-field').removeClass('step-parent-active');
                    jQuery('.step1-field').addClass('step-parent-active');
                }
            }
        });
        InputControls.tooltip();
    },

    /*
    ** Drag Feature Function
    **/

    drag_feature: function () {
        jQuery('.organize-group__list').sortable({
            placeholder: "fb-options__highlight",
            scroll: true,
            axis: "y",
            handle: ".organize-group__action",
            start:function(){
                jQuery('.fb-options__highlight').text('Drop Your Element Here');
                SaveContactPreviewChanges.disableOrganizeButton(false);
            },
        });
    },

    /*
    ** Contact Form Setup Function
    **/

    contact_setup: function () {
        jQuery('.add-input-button').unbind('click').click(function (e){
            e.preventDefault();
            trigger_old_value = null;
            if(jQuery(this).parents('.contact-fields-wrap').find(".input2-field").css("display") == "block"){

                if(jQuery(this).parents('.contact-fields-wrap').find(".input3-field").css("display") == "none"){
                    jQuery(this).parents('.contact-fields-wrap').find(".input3-field").css("display", "block");
                    SaveContactPreviewChanges.setHideDropdown(3, 0);
                    SaveContactPreviewChanges.updateFieldsStatus(3, 1);
                }

            } else {
                if($('.fb-tab__link.active').hasClass('step-2'))
                {
                    jQuery(this).parents('.contact-fields-wrap').find(".input2-field").css("display", "block");
                    let existing_active_fields = SaveContactPreviewChanges.disableAddButtonStep2(true);
                    let all_fields = [0,4,5];
                    let update_index = '';
                    $.each(all_fields,function(i,val){
                        var result=$.inArray(val,existing_active_fields);
                        if(result ==-1)
                            update_index = val;
                    })
                    let array_index = SaveContactPreviewChanges.findArrayIndex(update_index);
                    $('.input-type1-step1').val(array_index).change();
                    SaveContactPreviewChanges.setHideDropdown(2, 0);
                    SaveContactPreviewChanges.updateFieldsStatus(2, 1);
                }
                else{
                    jQuery(this).parents('.contact-fields-wrap').find(".input2-field").css("display", "block");
                    SaveContactPreviewChanges.setHideDropdown(2, 0);
                    SaveContactPreviewChanges.updateFieldsStatus(2, 1);
                }
            }
            SaveContactPreviewChanges.sortingSequence();

            if(jQuery(this).parents('.contact-fields-wrap').find(".input2-field").css("display") == "block" && jQuery(this).parents('.contact-fields-wrap').find(".input3-field").css("display") == "block" ){
                jQuery(this).parents('.contact-fields-wrap').find(".add-input-button").css("display", "none");
            }
            if(jQuery(this).parents('.contact-fields-wrap').find(".input2-field").css("display") == "block" || jQuery(this).parents('.contact-fields-wrap').find(".input3-field").css("display") == "block" ){
                jQuery(this).parents('.contact-fields-wrap').find(".lp-btn_organize").css("display", "inline-flex");
            }
            if($('.fb-tab__link.step-2').hasClass('active'))
            {
                $('[data-add-dropdown]').hide();
            }
        });

        $('.hide-button-2').click(function (e){
            e.preventDefault();
            if (SaveContactPreviewChanges.isHideDropdown(3)) {
                if(site.env_production.toLowerCase() == "local") console.info('hiding dropdown 222');
                jQuery(this).parents(".input2-field").css("display", "none");
                jQuery(this).parents('.contact-fields-wrap').find(".add-input-button").css("display", "inline-flex");
                jQuery(this).parents('.contact-fields-wrap').find(".lp-btn_organize").css("display", "none");
                if ($(this).parents(".input2-field").css("display") == "none" && jQuery(this).parents('.contact-fields-wrap').find(".input3-field").css("display") == "block") {
                }
            } else {
                if(site.env_production.toLowerCase() == "local") console.info('hiding dropdown 3 from button 2');
                jQuery('.hide-button-3').parents(".input3-field").css("display", "none");
                jQuery('.hide-button-3').parents('.contact-fields-wrap').find(".add-input-button").css("display", "inline-flex");
            }
        });

        jQuery('.hide-button-3').click(function (e){
            e.preventDefault();
            jQuery(this).parents(".input3-field").css("display", "none");
            jQuery(this).parents('.contact-fields-wrap').find(".add-input-button").css("display", "inline-flex");
        });

    },

    /*
    ** init Function
    **/

    init: function() {
        SaveContactPreviewChanges.renderContactForm();
        contact_info_overlay.openclose();
        contact_info_overlay.allCustomSelect();
        contact_info_overlay.drag_feature();
        contact_info_overlay.contact_setup();
        SaveContactPreviewChanges.addRemoveDropdown();
        SaveContactPreviewChanges.setSortingPopup();
        SaveContactPreviewChanges.saveSortingPopup();
        SaveContactPreviewChanges.savePhoneSettingsPopup();
        SaveContactPreviewChanges.loadPhoneSettingsClick();
        SaveContactPreviewChanges.navigateContactQuestion();
    },
};

var SaveContactPreviewChanges = {
    firstLoad: true,
    organizeSorting: false,
    /**
     * Save contact form for name-variations and email/phone in local storage
     * @param value
     * @param field_type
     * @param step
     */
    saveContactForm: function (value, field_type, step) {
        let step_val = contact_info_overlay.step_val[step];
        let selector = $('[data-input-'+step_val+'-parent]');
        if (field_type == 'name-variation') {
            let fieldMapping = SaveContactPreviewChanges.getNameVariationMapping(value);
            this.saveContactFormJson(fieldMapping);
        } else if (field_type == 'name-email-phone') {
// activate name variation

            if (value == 1) {
                let mappingVal = selector.find('.contact-variation-step'+step).val();
                let fieldMapping = SaveContactPreviewChanges.getNameVariationMapping(mappingVal);
                this.saveContactFormJson(fieldMapping);
// deactivate email and phone
                SaveContactPreviewChanges.deactiveContactFields(2);
                SaveContactPreviewChanges.deactiveContactFields(3);
            } else if (value == 2) {
                let emailVal = selector.find('[data-field-mapping="email"]').val().trim();
                let fieldMapping = SaveContactPreviewChanges.getEmailPhoneMapping(value);
                this.saveContactFormJson(fieldMapping, [emailVal]);
// deactivate name variations and phone
                SaveContactPreviewChanges.deactiveContactFields(1);
                SaveContactPreviewChanges.deactiveContactFields(3);
            } else if (value == 3) {
                let phoneVal = selector.find('[data-field-mapping="phone"]').val().trim();
                let fieldMapping = SaveContactPreviewChanges.getEmailPhoneMapping(value);
                this.saveContactFormJson(fieldMapping, [phoneVal]);
// deactivate name variations and email
                SaveContactPreviewChanges.deactiveContactFields(1);
                SaveContactPreviewChanges.deactiveContactFields(2);
            }
        }

        SaveChangesPreview.updateQuickAccessLinks();
    },

    /**
     * Deactive contact fields by making value=0
     * @param value
     */
    deactiveContactFields: function (value) {
        let deactivateField = true;
        if (SaveContactPreviewChanges.isHideDropdown(2) === false && SaveContactPreviewChanges.getDropdownValue(2) == value) {
            deactivateField = false;
        }
        if (SaveContactPreviewChanges.isHideDropdown(3) === false && SaveContactPreviewChanges.getDropdownValue(3) == value) {
            deactivateField = false;
        }
        if (SaveContactPreviewChanges.getDropdownValue(1) == value) {
            deactivateField = false;
        }

        if(site.env_production.toLowerCase() == "local") console.info('deactivateField', value, deactivateField);

        if (deactivateField) {
            let funnel_info = FunnelsUtil._getFunnelInfo('local_storage');
            let mappedFields = SaveContactPreviewChanges.getContactMappedFields(funnel_info);

            if (value == 1) {
                SaveContactPreviewChanges.deactivateNameVariations(mappedFields);
            } else {
                let fieldMapping = SaveContactPreviewChanges.getEmailPhoneMapping(value);
                SaveContactPreviewChanges.deactivateEmailPhone(mappedFields, fieldMapping);
            }

            FunnelsUtil.saveFunnelData(funnel_info);
            SaveContactPreviewChanges.hideShowUniqueVariableRequiredFields();
            if (SaveContactPreviewChanges.organizeSorting === false) {
                // SaveContactPreviewChanges.setSorting();
                 SaveContactPreviewChanges.sortingSequence();
            } else {
                SaveContactPreviewChanges.updateSorting();
                SaveChangesPreview.iframePostMessage();
            }
        }
    },

    /**
     * Check if dropdown 2 or 3 is hide
     * @param dropdown
     * @returns {boolean}
     */
    isHideDropdown: function (dropdown) {
        return ($('[data-id="hide_dropdown_'+dropdown+'"]').val() == 1) ? true : false;
    },

    /**
     * Deactivate OR Toggle(enable/disable) email and phone number
     * @param mappedFields
     * @param value
     */
    deactivateEmailPhone: function (mappedFields, value) {
        let mappedFieldKey = mappedFields[value];
        let key = Object.keys(mappedFieldKey);
        mappedFieldKey[key]['value'] = 0;
    },

    /**
     * Get name field variations mapping for dropdown values with json mapped values
     * @param value
     * @returns {number}
     */
    getNameVariationMapping: function (value) {
        let mapping;

        if (value == 1) {
            mapping = 3;
        } else if (value == 2) {
            mapping = 1;
        } else if (value == 3) {
            mapping = 0;
        }

        return mapping;
    },

    /**
     * Get name field variations mapping for json mapped values with dropdown values
     * @param value
     * @returns {number}
     */
    getNameVariationMappingReverse: function (value) {
        let mapping;

        if (value == 3) {
            mapping = 1;
        } else if (value == 1) {
            mapping = 2;
        } else if (value == 0) {
            mapping = 3;
        }

        return mapping;
    },

    /**
     * Get email and phone mapping for dropdown values with json mapped values
     * @param value
     * @returns {number}
     */
    getEmailPhoneMapping: function (value) {
        let mapping;

        if (value == 2) {
            mapping = 4;
        } else if (value == 3) {
            mapping = 5;
        }

        return mapping;
    },

    /**
     * Save contact form in local storage as per mapping
     * @param fieldMapping
     * @param labelVal
     */
    saveContactFormJson: function(fieldMapping, labelVal=null) {
        let funnel_info = FunnelsUtil._getFunnelInfo('local_storage');
        let mappedFields = SaveContactPreviewChanges.getContactMappedFields(funnel_info);

        if (labelVal === null) {
            SaveContactPreviewChanges.toggleActiveNameVariation(fieldMapping, mappedFields);
        }

        // saving first+last name
        if (Array.isArray(labelVal)) {
            labelVal.forEach((item) => {
                let mappedFieldKey = mappedFields[fieldMapping];
                let key = Object.keys(mappedFieldKey);

                mappedFieldKey[key]['field-label'] = item;
                if(key != 'only-first-name'){
                    mappedFieldKey[key]['value'] = 1;
                }else{
                    //sync only first name and first name field label
                    mappedFields[1]['first-name']['field-label'] = item;
                }

                if(site.env_production.toLowerCase() == "local") console.info('updated', mappedFieldKey[key]);
                fieldMapping++;
            });
        }
        FunnelsUtil.saveFunnelData(funnel_info);
        SaveContactPreviewChanges.hideShowUniqueVariableRequiredFields();
        if (SaveContactPreviewChanges.organizeSorting === false) {
            // SaveContactPreviewChanges.setSorting();
            SaveContactPreviewChanges.sortingSequence();
        } else {
            SaveContactPreviewChanges.updateSorting();
            SaveChangesPreview.iframePostMessage();
        }
    },

    /**
     * Enable/Disable fields while switching name field variations
     * @param fieldMapping
     * @param mappedFields
     */
    toggleActiveNameVariation: function (fieldMapping, mappedFields) {
        fieldMapping = Number(fieldMapping);
        for (let i = 0; i <= 3; i++) {
            let mappedFieldInactive = mappedFields[i];
            let key = Object.keys(mappedFieldInactive);
            if (fieldMapping === 1 && (i === 1 || i === 2)) {
                mappedFieldInactive[key]['value'] = 1;
            } else if (i !== fieldMapping) {
                mappedFieldInactive[key]['value'] = 0;
            } else {
                mappedFieldInactive[key]['value'] = 1;
            }
        }
    },

    /**
     * Save field labels into local storage
     * @param event
     */
    saveContactTextFields: function (event) {
        let step = event.target.dataset.changeContactFields;
        let labelVal = [];
        let fieldMapping;

        let name_variation_selected = $('.contact-variation-step'+step).val();
        let val = event.target.value.trim();

        let field = event.target.dataset.fieldMapping;
        if (field == 'email') {
            fieldMapping = 4;
            $('[data-input-one-parent], [data-input-two-parent], [data-input-three-parent]').find('[data-field-mapping="email"]').val(val);
        } else if (field == 'phone') {
            fieldMapping = 5;
            $('[data-input-one-parent], [data-input-two-parent], [data-input-three-parent]').find('[data-field-mapping="phone"]').val(val);
        } else {
            fieldMapping = SaveContactPreviewChanges.getNameVariationMapping(name_variation_selected);
        }

        // save first name and last name
        if (fieldMapping === 1) {
            let step_val = contact_info_overlay.step_val[step];
            let selector = $('[data-input-'+step_val+'-parent]');
            let firstNameVal = selector.find('[data-field-mapping="first-name"]').val().trim();
            let lastNameVal = selector.find('[data-field-mapping="last-name"]').val().trim();
            labelVal.push(firstNameVal);
            labelVal.push(lastNameVal);
            // copy first-name value in only-first-name
            labelVal.push(firstNameVal);
            $('[data-input-one-parent], [data-input-two-parent], [data-input-three-parent]').find('[data-field-mapping="first-name"]').val(firstNameVal);
            $('[data-input-one-parent], [data-input-two-parent], [data-input-three-parent]').find('[data-field-mapping="last-name"]').val(lastNameVal);
        } else if (fieldMapping === 0) {
            labelVal.push(val);
            $('[data-input-one-parent], [data-input-two-parent], [data-input-three-parent]').find('[data-field-mapping="fullname"]').val(val);
        } else if (fieldMapping === 3) {
            labelVal.push(val);
            $('[data-input-one-parent], [data-input-two-parent], [data-input-three-parent]').find('[data-field-mapping="first-name"]').val(val);
        } else {
            labelVal.push(val);
        }

        if (labelVal.length) {
            if(site.env_production.toLowerCase() == "local") console.info(fieldMapping, labelVal);
            this.saveContactFormJson(fieldMapping, labelVal);
        }
    },

    /**
     * Get mapped fields for active step from local storage
     * @param funnel_info
     * @returns {*}
     */
    getContactMappedFields: function (funnel_info, getFields=true) {
        let ques_id = $('[data-id="ques_id"]').val();
        let active_step = $('[data-id="active_step"]').val() - 1;
        let active_slide = $('[data-id="active_slide"]').val();
        let mappedFields = funnel_info.questions[ques_id]['options']['all-step-types'][active_step]['steps'][active_slide];

        return (getFields===true) ? mappedFields['fields'] : mappedFields;
    },

    /**
     * Update fields value to 0 or 1
     * @param step
     * @param status
     */
    updateFieldsStatus: function (step, status) {
        let step_val = contact_info_overlay.step_val[step];
        let selector = $('[data-input-'+step_val+'-parent]');
        let step_use = (step == 1)? '' :step-1;
        let selected_val = selector.find('.input-type'+step_use+'-step1').val();

        let funnel_info = FunnelsUtil._getFunnelInfo('local_storage');
        let mappedFields = SaveContactPreviewChanges.getContactMappedFields(funnel_info);

        if (selected_val == 1) {
            if (status == 0) {
                SaveContactPreviewChanges.deactivateNameVariations(mappedFields);
            } else if (status == 1) {
                let fieldMapping = selector.find('.contact-variation-step'+step).val();
                fieldMapping = SaveContactPreviewChanges.getNameVariationMapping(fieldMapping);
                if(site.env_production.toLowerCase() == "local") console.info('updated status fieldMapping', fieldMapping);
                SaveContactPreviewChanges.toggleActiveNameVariation(fieldMapping, mappedFields);
            }
        } else {

            let mapping = SaveContactPreviewChanges.getEmailPhoneMapping(selected_val);
            let mappedFieldKey = mappedFields[mapping];
            let key = Object.keys(mappedFieldKey);
            mappedFieldKey[key]['value'] = status;
            if(site.env_production.toLowerCase() == "local") console.info('updated status', mappedFieldKey[key]);
            FunnelsUtil.saveFunnelData(funnel_info);
        }
        SaveContactPreviewChanges.hideShowUniqueVariableRequiredFields();
        if (SaveContactPreviewChanges.organizeSorting === false) {
            SaveContactPreviewChanges.setSorting();
        } else {
            SaveContactPreviewChanges.updateSorting();
            SaveChangesPreview.iframePostMessage();
        }
        FunnelsUtil.saveFunnelData(funnel_info);

        SaveChangesPreview.updateQuickAccessLinks(funnel_info);
    },

    /**
     * Contact form debugging function to see updated values in local storage
     * Used manually while development in console to see changes got updated in local storage
     */
    contactFormDebugging: function () {
        let funnel_info = FunnelsUtil._getFunnelInfo('local_storage');
        let mappedFields = SaveContactPreviewChanges.getContactMappedFields(funnel_info);

        for (let i = 0; i <= 5; i++) {
            let mappedFieldKey = mappedFields[i];
            let key = Object.keys(mappedFieldKey);
            if(site.env_production.toLowerCase() == "local") console.info(key.toString(), mappedFieldKey[key]);
        }
    },

    /**
     * Deactivate name variations by setting value=0
     * @param mappedFields
     */
    deactivateNameVariations: function (mappedFields) {
        for (let i = 0; i <= 3; i++) {
            let mappedFieldKey = mappedFields[i];
            let key = Object.keys(mappedFieldKey);
            mappedFieldKey[key]['value'] = 0;
            if(site.env_production.toLowerCase() == "local") console.info('updated status', mappedFieldKey[key]);
        }
    },

    /**
     * Set sorting as per dropdown's selected values in local storage
     * @param sequence
     */
    setSorting: function (sequence=null) {
        let sorting = [];
        let funnel_info = FunnelsUtil._getFunnelInfo('local_storage');
        let mappedFields = SaveContactPreviewChanges.getContactMappedFields(funnel_info, false);
        if (sequence === null) {
            SaveContactPreviewChanges.setSortingFields(1, sorting);
            SaveContactPreviewChanges.setSortingFields(2, sorting);
            SaveContactPreviewChanges.setSortingFields(3, sorting);
        } else {
            sequence.forEach((item) => {
                SaveContactPreviewChanges.setSortingFields(item, sorting, true);
            });
        }
        if(site.env_production.toLowerCase() == "local") console.info('sorting', sorting);

        mappedFields['field-order'] = sorting;
        FunnelsUtil.saveFunnelData(funnel_info);
        SaveChangesPreview.iframePostMessage();
    },

    /**
     * Set sorting array for all dropdown
     * @param dropdown
     * @param sorting
     */
    setSortingFields: function (dropdown, sorting, useItem=false) {
        if (useItem) {
            dropdown = SaveContactPreviewChanges.getSelectedDropdownValue(dropdown);
        }
        let dropdown_val = SaveContactPreviewChanges.getDropdownValue(dropdown);
        if (dropdown_val == 1) {
            let name_variation_selected = $('.contact-variation-step'+dropdown).val();
            let fieldMapping = SaveContactPreviewChanges.getNameVariationMapping(name_variation_selected);

            if (fieldMapping == 1) {
                sorting.push(1);
                sorting.push(2);
            } else {
                sorting.push(fieldMapping);
            }
        } else if (dropdown_val !== null) {
            sorting.push(SaveContactPreviewChanges.getEmailPhoneMapping(dropdown_val));
        }
    },

    /**
     * Get Dropdown which has value 1
     * @returns {number}
     */
    getSelectedDropdownValue: function (selected_dropdown) {
        let dropdown;
        let dropdown1_val = $('[data-input-one-parent] .input-type-step1').val();
        let dropdown2_val = $('[data-input-two-parent] .input-type1-step1').val();
        let dropdown3_val = $('[data-input-three-parent] .input-type2-step1').val();
        if (dropdown1_val == selected_dropdown) {
            dropdown = 1;
        } else if (dropdown2_val == selected_dropdown) {
            dropdown = 2;
        } else if (dropdown3_val == selected_dropdown) {
            dropdown = 3;
        }

        return dropdown;
    },

    /**
     * Update sorting if something got changed in particularly name variation
     */
    updateSorting: function () {
        $('[data-organize-save]').click();
    },

    /**
     * Save unique variable name
     * @param event
     */
    saveUniqueVariableName: function (event) {
        let field_name = event.target.dataset.fieldName;
        let funnel_info = FunnelsUtil._getFunnelInfo('local_storage');
        let mappedFields = SaveContactPreviewChanges.getContactMappedFields(funnel_info);

        for (let i = 0; i <= 5; i++) {
            let mappedFieldKey = mappedFields[i];
            let key = Object.keys(mappedFieldKey);
            if (key == field_name) {
                mappedFieldKey[key]['unique-variable-name'] = event.target.value;
                break;
            }
        }

        FunnelsUtil.saveFunnelData(funnel_info);
//SaveChangesPreview.iframePostMessage();
    },

    /**
     * Hide/Show unique variable and required fields
     */
    hideShowUniqueVariableRequiredFields: function () {
        let funnel_info = FunnelsUtil._getFunnelInfo('local_storage');
        let mappedFields = SaveContactPreviewChanges.getContactMappedFields(funnel_info);

        for (let i = 0; i <= 5; i++) {
            let mappedFieldKey = mappedFields[i];
            let key = Object.keys(mappedFieldKey);

// set value for unique variable name
            $('[data-field-name="'+key+'"]').val(mappedFieldKey[key]['unique-variable-name']);
            $('[data-field="'+key+'"]').data('value', mappedFieldKey[key]['unique-variable-name']);

// enable/disable checkbox for required
            if (mappedFieldKey[key]['required'] == 1) {
                $('[data-field-name="'+key+'.required"]').prop('checked', true);
            } else {
                $('[data-field-name="'+key+'.required"]').prop('checked', false);
            }

// hide/show unique variable name and required fields
            if (mappedFieldKey[key]['value'] == 1) {
                $('[data-field-name="'+key+'"]').closest('.fb-form__group-holder').show();
                $('[data-field-name="' + key + '.required"]').closest('li').show();
            } else {
                $('[data-field-name="'+key+'"]').closest('.fb-form__group-holder').hide();
                $('[data-field-name="'+key+'.required"]').closest('li').hide();
            }

        }
    },

    /**
     * Get field index by field key
     * @param field
     * @returns {number}
     */
    getFieldIndex: function (field) {
        let funnel_info = FunnelsUtil._getFunnelInfo('local_storage');
        let mappedFields = SaveContactPreviewChanges.getContactMappedFields(funnel_info);

        for (let i = 0; i <= 5; i++) {
            let mappedFieldKey = mappedFields[i];
            let key = Object.keys(mappedFieldKey);
            if (key == field) {
                return i;
            }
        }
    },

    /**
     * Show/Hide Required Checkbox
     */
    showHideRequiredCheckbox: function () {
        let funnel_info = FunnelsUtil._getFunnelInfo('local_storage');
        let mappedFields = SaveContactPreviewChanges.getContactMappedFields(funnel_info);

        for (let k = 0; k <= 5; k++) {
            let mappedFieldKey = mappedFields[k];
            let key = Object.keys(mappedFieldKey);
            if (mappedFields[k][key]['value'] == 1 && mappedFields[k][key]['required'] == 1) {
                $('[data-required-opener]').prop('checked', true);
                $('[data-required-slide]').show();
                return;
            }
        }

        $('[data-required-opener]').prop('checked', false);
        $('[data-required-slide]').hide();
        $('[data-cta-button]').hide();
    },

    /**
     * Contact form populate data
     */
    contactFormPopulateData: function () {
//SaveContactPreviewChanges.organizeSorting = false;
        let funnel_info = FunnelsUtil._getFunnelInfo('local_storage');
        let mappedFields = SaveContactPreviewChanges.getContactMappedFields(funnel_info, false);
        if(site.env_production.toLowerCase() == "local") console.info('mappedFields', mappedFields);
        let sequence = mappedFields['field-order'];
        let orderKey = [];
        let orderVal = [];
        let nameKey = [];
        SaveContactPreviewChanges.setOrderKeyVal(orderKey, orderVal, sequence, nameKey);

        if(site.env_production.toLowerCase() == "local") console.info("orderKey", orderKey);
        if(site.env_production.toLowerCase() == "local") console.info("orderVal", orderVal);
        if(site.env_production.toLowerCase() == "local") console.info("nameKey", nameKey);

        SaveContactPreviewChanges.setActiveDropdowns(3);
        SaveContactPreviewChanges.setHideDropdown(2, 0);
        SaveContactPreviewChanges.setHideDropdown(3, 0);
        if (orderKey.length == 1) {
            SaveContactPreviewChanges.setHideDropdown(2, 1);
            SaveContactPreviewChanges.setHideDropdown(3, 1);
        } else if (orderKey.length == 2) {
            SaveContactPreviewChanges.setHideDropdown(3, 1);
        }

// set hide dropdown 2/3
        let nameVariationPopulate = false;
        let mappedFieldsHide = mappedFields['fields'];
        for (let i = 0; i <= 5; i++) {
            let mappedFieldKey = mappedFieldsHide[i];
            let key = Object.keys(mappedFieldKey);

            if (i <= 3 && mappedFieldsHide[i][key]['value'] == 1) {
                nameVariationPopulate = true;
            }

            if (i == 3 && nameVariationPopulate === false && orderKey[1] == 1) {
                SaveContactPreviewChanges.setHideDropdown(2, 1);
                if(site.env_production.toLowerCase() == "local") console.info('hiding dropdown 2', SaveContactPreviewChanges.isHideDropdown(2), mappedFieldsHide[i][key]['value'], i);
            }
            let dropdown2_val_email_phone = (orderKey[1] != 1) ? SaveContactPreviewChanges.getEmailPhoneMapping(orderKey[1]) : -1;
            if (dropdown2_val_email_phone == i && mappedFieldsHide[i][key]['value'] == 0) {
                SaveContactPreviewChanges.setHideDropdown(2, 1);
                if(site.env_production.toLowerCase() == "local") console.info('hiding dropdown 2', SaveContactPreviewChanges.isHideDropdown(2), mappedFieldsHide[i][key]['value'], i);
            }

            if (i == 3 && nameVariationPopulate === false && orderKey[2] == 1) {
                SaveContactPreviewChanges.setHideDropdown(3, 1);
                if(site.env_production.toLowerCase() == "local") console.info('hiding dropdown 3', SaveContactPreviewChanges.isHideDropdown(3), mappedFieldsHide[i][key]['value'], i);
            }
            let dropdown3_val_email_phone = (orderKey[2] != 1) ? SaveContactPreviewChanges.getEmailPhoneMapping(orderKey[2]) : -1;
            if (dropdown3_val_email_phone == i && mappedFieldsHide[i][key]['value'] == 0) {
                SaveContactPreviewChanges.setHideDropdown(3, 1);
                if(site.env_production.toLowerCase() == "local") console.info('hiding dropdown 3', SaveContactPreviewChanges.isHideDropdown(3), mappedFieldsHide[i][key]['value'], i);
            }
        }

        SaveContactPreviewChanges.updateDropdowns('input-type-step1', orderKey[0], orderKey[1]);
        $('.input-type-step1').val(orderKey[0]).trigger('change.select2');
        contact_info_overlay.inputTypeShowHide(orderKey[0], 1);

        if (orderKey[1]) {
            if(site.env_production.toLowerCase() == "local") console.info('setting value dropdown 2', orderKey[1]);
            $('.input-type1-step1').val(orderKey[1]).trigger('change.select2');
        }
        if (SaveContactPreviewChanges.isHideDropdown(2)) {
            let currentVal = SaveContactPreviewChanges.getActiveDropdowns();
            SaveContactPreviewChanges.setActiveDropdowns(Number(currentVal) - 1);
            $('[data-add-dropdown]').show();
            $('[data-input-two-parent]').hide();
        } else {
            contact_info_overlay.inputTypeShowHide(orderKey[1], 2);
            $('[data-organize]').attr('style', 'display:flex');
        }
        if (orderKey[2]) {
            if(site.env_production.toLowerCase() == "local") console.info('setting value dropdown 3', orderKey[2]);
            $('.input-type2-step1').val(orderKey[2]).trigger('change.select2');
        }
        if (SaveContactPreviewChanges.isHideDropdown(3)) {
            let currentVal = SaveContactPreviewChanges.getActiveDropdowns();
            SaveContactPreviewChanges.setActiveDropdowns(Number(currentVal) - 1);
            $('[data-add-dropdown]').show();
            $('[data-input-three-parent]').hide();
        } else {
            contact_info_overlay.inputTypeShowHide(orderKey[2], 3);
            $('[data-organize]').attr('style', 'display:flex');
        }

        if (nameKey.length == 0) {
            if (SaveContactPreviewChanges.isHideDropdown(2)) {
                setTimeout(function () {
                    contact_info_overlay.nameVariationShowHide(2);
                }, 1050);
            } else {
                setTimeout(function () {
                    contact_info_overlay.nameVariationShowHide(3);
                }, 1050);
            }
        } else {
            for (let i = 0; i <= 2; i++) {
                if (orderKey[i] == 1) {
                    let step = i + 1;
                    setTimeout(function () {
                        $('.contact-variation-step' + step).val(nameKey[0]).trigger('change.select2');
                        contact_info_overlay.nameVariationShowHide(step);
                    }, 1050);
                }
            }
        }
// set country code and auto-format phone settings
        SaveContactPreviewChanges.loadPhoneSettings();
// set contact form text
        SaveContactPreviewChanges.setContactFormSetupText();
    },

    /**
     * Load phone settings
     */
    loadPhoneSettings: function () {
        let funnel_info = FunnelsUtil._getFunnelInfo('local_storage');
        let mappedFields = SaveContactPreviewChanges.getContactMappedFields(funnel_info, false);
        $('.country-code').val(mappedFields['fields'][5]['phone']['country-code']??0).trigger('change.select2');
        $('.phone-format').val(mappedFields['fields'][5]['phone']['auto-format']??1).trigger('change.select2');
    },

    /**
     * Load phone settings click handling
     */
    loadPhoneSettingsClick: function () {
        $('[data-load-phone-settings]').click(function () {
            SaveContactPreviewChanges.loadPhoneSettings();
        });
    },

    /**
     * Get Active Dropdowns count
     * @returns {number}
     */
    getActiveDropdowns: function () {
        return $('[data-id="active_dropdowns"]').val();
    },

    /**
     * Set Active Dropdowns count
     * @param val
     */
    setActiveDropdowns: function (val) {
        $('[data-id="active_dropdowns"]').val(val);
    },

    /**
     * Set hide dropdown value
     * @param dropdown
     * @param val
     */
    setHideDropdown: function (dropdown, val) {
        $('[data-id="hide_dropdown_'+dropdown+'"]').val(val);
    },

    /**
     * Set hide dropdown value
     * @param dropdown
     * @param val
     */
    getDropdownValue: function (dropdown) {
        let val;

        if (dropdown == 1) {
            val = $('[data-input-one-parent] .input-type-step1').val();
        } else if (dropdown == 2) {
            val = $('[data-input-two-parent] .input-type1-step1').val();
        } else if (dropdown == 3) {
            val = $('[data-input-three-parent] .input-type2-step1').val();
        }

        return val;
    },

    /**
     * Render contact form template using handlebar
     */
    renderContactForm: function() {
        let funnel_info = FunnelsUtil._getFunnelInfo('local_storage');

// save active_slide to use in right preview
        let ques_id = $('[data-id="ques_id"]').val();
        funnel_info.questions[ques_id]['active_slide'] = $('[data-id="active_slide"]').val();
        FunnelsUtil.saveFunnelData(funnel_info);
        SaveChangesPreview.iframePostMessage();

        let mappedField = SaveContactPreviewChanges.getContactMappedFields(funnel_info, false);
        hbar.renderTemplate('contact-form.hbs', "contactFormEditor", mappedField);
    },

    /**
     * Add/Remove dropdown to manage active dropdown count and update field's value=0 or value=1
     */
    addRemoveDropdown: function() {
        $('[data-delete-dropdown]').click(function () {

            let currentVal = SaveContactPreviewChanges.getActiveDropdowns();
            SaveContactPreviewChanges.setActiveDropdowns(Number(currentVal)-1);
            let dropdown = $(this).data('delete-dropdown');
            if(site.env_production.toLowerCase() == "local") console.info('deleting dropdown', dropdown);
            // delete dropdown 3 if we are deleting dropdown 2
            if (dropdown == 2) {
                if (SaveContactPreviewChanges.isHideDropdown(3) === false) {
                    dropdown = 3;
                    let dropdown3_val = SaveContactPreviewChanges.getDropdownValue(3);
                    let drop2 = $('[data-input-two-parent]').find('.input-type1-step1').val();
                    $('[data-input-two-parent]').find('.input-type1-step1').val(dropdown3_val).change();
                    $('[data-input-three-parent]').find('.input-type2-step1').val(drop2).change();
                }
            }

            SaveContactPreviewChanges.organizeSorting = true;
            if(site.env_production.toLowerCase() == "local") console.info('hiding dropdown', dropdown);
            SaveContactPreviewChanges.setHideDropdown(dropdown, 1);
            SaveContactPreviewChanges.updateFieldsStatus(dropdown, 0);
            SaveContactPreviewChanges.organizeSorting = false;
        });

        $('[data-add-dropdown]').click(function () {
            let currentVal = SaveContactPreviewChanges.getActiveDropdowns();
            SaveContactPreviewChanges.setActiveDropdowns(Number(currentVal)+1);
        });
    },

    /**
     * Set sorting popup window
     */
    setSortingPopup: function () {
        $('[data-organize]').click(function () {
            if (SaveContactPreviewChanges.organizeSorting === false) {
//SaveContactPreviewChanges.organizeSorting = true;
//  SaveContactPreviewChanges.setSorting();
            }
            let funnel_info = FunnelsUtil._getFunnelInfo('local_storage');
            let mappedFields = SaveContactPreviewChanges.getContactMappedFields(funnel_info, false);
            let sequence = mappedFields['field-order'];
            let orderKey = [];
            let orderVal = [];
            SaveContactPreviewChanges.setOrderKeyVal(orderKey, orderVal, sequence);
            if(site.env_production.toLowerCase() == "local") console.info("orderKey", orderKey);
            if(site.env_production.toLowerCase() == "local") console.info("orderVal", orderVal);

            let i = 0;
            jQuery('.organize-group__list').find('.organize-group__name').each((pos, el) => {
// hide/show deleted dropdown
                let dropdown = SaveContactPreviewChanges.getSelectedDropdownValue(orderKey[i]);
                if (dropdown == undefined || SaveContactPreviewChanges.isHideDropdown(dropdown)) {
                    jQuery(el).closest('.organize-group__item').hide();
                } else {
                    jQuery(el).closest('.organize-group__item').show();
                }
                jQuery(el).data('id', orderKey[i]);
                jQuery(el).html(orderVal[i]);
                i++;
            });
        });
        this.disableOrganizeButton(true);
    },

    /**
     * Set order key, val key and name key
     * @param orderKey
     * @param orderVal
     * @param sequence
     * @param nameKey
     */
    setOrderKeyVal: function (orderKey, orderVal, sequence, nameKey=null) {
        let nameVariation = false;

        for (let i = 0; i <= sequence.length; i++) {
            if ($.inArray(sequence[i], [0, 1, 2, 3]) !== -1 && nameVariation === false) {
                if (nameKey !== null) {
                    if(site.env_production.toLowerCase() == "local") console.info('sequence val', sequence[i]);
                    let fieldMapping = SaveContactPreviewChanges.getNameVariationMappingReverse(sequence[i]);
                    nameKey.push(fieldMapping);
                }
                nameVariation = true;
                orderKey.push(1);
                orderVal.push('Name');
            } else if ($.inArray(sequence[i], [4, 5]) !== -1) {
                let val = (sequence[i] == 4) ? 2 : 3;
                let name = (sequence[i] == 4) ? 'Email' : 'Phone';
                orderKey.push(val);
                orderVal.push(name);
            }
        }
    },

    /**
     * enable/disable contact organize popup save button
     * @param is_disabled
     */
    disableOrganizeButton: function(is_disabled = false){
        $('[data-organize-save]').prop("disabled", is_disabled);
    },

    /**
     * Save sorting in popup
     */
    saveSortingPopup: function () {
        $('[data-organize-save]').click(function () {
            if (SaveContactPreviewChanges.organizeSorting === false) {
                let sequence = [];
                jQuery('.organize-group__list').find('.organize-group__name').each((pos, el) => {
                    if($('.organize-group__name').eq(pos).is(':visible'))
                    {
                        let question = jQuery(el).data('id');
                        sequence.push(question);
                    }
                });

                if(site.env_production.toLowerCase() == "local") console.info('sequence on save', sequence);
                SaveContactPreviewChanges.setSorting(sequence);
                SaveContactPreviewChanges.organizeSorting = true;
                SaveContactPreviewChanges.loadContactForm(false);
                setTimeout(function () {
                    SaveChangesPreview.iframePostMessage();
                    SaveContactPreviewChanges.organizeSorting = false;
                }, 1500);
                SaveChangesPreview.updateQuickAccessLinks();
                if($('.fb-tab__link.step-2').hasClass('active'))
                {
                    SaveContactPreviewChanges.disableAddButtonStep2();
                }
            }
            $('#group-organize-pop').modal('hide');
        });
    },

    /**
     * Save phone settings in popup
     */
    savePhoneSettingsPopup: function () {
        $('[data-phone-settings-save]').click(function (event) {
            let country_code = $('.country-code').val() == '-1' || $('.country-code').val() == null?1:$('.country-code').val();
            let phone_format = $('.phone-format').val() == '-1' || $('.phone-format').val() == null?1:$('.phone-format').val();
            let active_step = $('[data-contact-nav-id].active').attr('data-contact-nav-id')-1;
// let format =selectItems['update-phone-format'][0]['country-code'][0][country_code][0]['phone-format'][0][phone_format];
// $('[data-field-mapping="phone"]').val(format);
// event.target.dataset.changeContactFields = active_step;
// event.target.dataset.fieldMapping = 'phone';
// event.target.value = format;
// SaveContactPreviewChanges.saveContactTextFields(event);
            SaveChangesPreview.saveJson('country-code', country_code);
            SaveChangesPreview.saveJson('auto-format', phone_format);
            $('#advance-setting .button-cancel').click();
        });

        $('#advance-setting .button-cancel').on('click',function (){
            $('[data-phone-settings-save]').attr('disabled',true);
        });
    },

    /**
     * Update contact form dropdowns for selected values
     * @param selectorClass
     * @param value
     * @param dropdown2_val
     */
    updateDropdowns: function(selectorClass, value, dropdown2_val=null) {
        let selector, selectorArr;
        if(dropdown2_val == null)
        {
            let dropdown_index = SaveContactPreviewChanges.findstepJsonIndex(value);
            $('.fb-options_drop-down select').each(function (index,element){
                if(!$(this).hasClass(selectorClass) && $(this).val() == value && !$(this).hasClass('contact-variation-step1')
                    && !$(this).hasClass('contact-variation-step2') && !$(this).hasClass('contact-variation-step3'))
                {
                    var classList = $(this).attr('class').split(/\s+/);
                    selector = classList[0];
                    selectorArr = selectItems[selector];

                    if(site.env_production.toLowerCase() == "local") console.info('excluding values for dropdown 3 udpatedropdowns', value, input_type1_step1_value);
                    let newData = SaveContactPreviewChanges.getDropdownNewDataArray(selectorArr, value);
                    $('.'+selector).select2('destroy').empty();
                    trigger_old_value = dropdown_old_value;
                    contact_info_overlay.initCustomSelect('.'+selector, '.'+selector+'-parent', newData);
                }
            });
        }
        else {
            let input_type_step1_value = -1;
            if (selectorClass == 'input-type-step1') {
                selector = 'input-type1-step1';
            } else if (selectorClass == 'input-type1-step1') {
                selector = 'input-type2-step1';
                input_type_step1_value = SaveContactPreviewChanges.getDropdownValue(1);
            }

            selectorArr = selectItems[selector];
            if(site.env_production.toLowerCase() == "local") console.info('excluding values for dropdown 2 udpatedropdowns', value, input_type_step1_value);
            let newData = SaveContactPreviewChanges.getDropdownNewData(selectorArr, value, input_type_step1_value);
// reset 2nd or 3rd dropdown
            $('.'+selector).select2('destroy').empty();
            contact_info_overlay.initCustomSelect('.'+selector, '.'+selector+'-parent', selectorArr);

// reset 3rd dropdown if 1st dropdown got changed
            if (selectorClass == 'input-type-step1') {
                selector = 'input-type2-step1';
                selectorArr = selectItems[selector];
                let input_type1_step1_value = dropdown2_val === null ? SaveContactPreviewChanges.getDropdownValue(2) : dropdown2_val;
                if(site.env_production.toLowerCase() == "local") console.info('excluding values for dropdown 3 udpatedropdowns', value, input_type1_step1_value);
                let newData = SaveContactPreviewChanges.getDropdownNewData(selectorArr, value, input_type1_step1_value);
                $('.'+selector).select2('destroy').empty();
                contact_info_overlay.initCustomSelect('.'+selector, '.'+selector+'-parent', selectorArr);
            }
        }
    },


    sortingSequence: function (){
        let sequence = [];
        jQuery('.organize-group__list').find('.organize-group__name').each((pos, el) => {
            let question = '';
            if (pos == 0) {
                question = $('[data-input-one-parent] .input-type-step1').val();
            } else if ($('[data-input-two-parent]').css('display') === 'block' && pos == 1 ) {
                question = $('[data-input-two-parent] .input-type1-step1').val();
            } else if ($('[data-input-three-parent]').css('display') === 'block' && pos == 2) {
                question = $('[data-input-three-parent] .input-type2-step1').val();
            }
            if (question !== undefined && question !== '')
            {
                sequence.push(question);
            }
        });
        SaveContactPreviewChanges.setSorting(sequence);
    },


    /**
     * Update contact form dropdowns selected values in other steps
     * @param selectorClass
     * @param dropdown_old_value
     * @param value
     */
    updateDropdownOtherSteps: function (selectorClass, dropdown_old_value, value=null,step)
    {

        let ques_id = $('[data-id="ques_id"]').val();
        let active_step = $('[data-id="active_step"]').val() - 1;
        let active_slide = $('[data-id="active_slide"]').val();
        let funnel_info_ques = FunnelsUtil._getFunnelInfo('local_storage');
        let all_steps = funnel_info_ques.questions[ques_id]['options']['all-step-types'][active_step]['steps'];
        let checkIndexJson = SaveContactPreviewChanges.findstepJsonIndex(value);
        let updateIndexJson = SaveContactPreviewChanges.findstepJsonIndex(dropdown_old_value);
        $.each(all_steps,function (index,el){

            let funnel_index = '';
            let arr_variations = 1;
            let sec_variations = 3;
            let variation_trigger = '';

            if(checkIndexJson == 0 && el['field-order'].includes(arr_variations))
            {
                all_steps[index]['field-order'].splice(all_steps[index]['field-order'].indexOf(2), 1);
                all_steps[index]['field-order'] = jQuery.grep(el['field-order'], function() {
                    return value != updateIndexJson;
                });
                let update_index = all_steps[index]['field-order'].indexOf(1);
                variation_trigger = 2;
                all_steps[index]['field-order'][update_index] = 0;
                funnel_info_ques.questions[ques_id]['options']['all-step-types'][active_step]['steps'][index]['field-order'] = all_steps[index]['field-order'];
                SaveContactPreviewChanges.updateFieldsValue(funnel_info_ques.questions[ques_id]['options']['all-step-types'][active_step]['steps'][index]['fields'],1,0);
                SaveContactPreviewChanges.updateFieldsValue(funnel_info_ques.questions[ques_id]['options']['all-step-types'][active_step]['steps'][index]['fields'],2,0);
                SaveContactPreviewChanges.updateFieldsValue(funnel_info_ques.questions[ques_id]['options']['all-step-types'][active_step]['steps'][index]['fields'],0,1);
            }
            else if(checkIndexJson == 0 && el['field-order'].includes(sec_variations)){
                all_steps[index]['field-order'] = jQuery.grep(el['field-order'], function() {
                    return value != updateIndexJson;
                });
                let update_index = all_steps[index]['field-order'].indexOf(3);
                all_steps[index]['field-order'][update_index] = 0;
                funnel_info_ques.questions[ques_id]['options']['all-step-types'][active_step]['steps'][index]['field-order'] = all_steps[index]['field-order'];
                SaveContactPreviewChanges.updateFieldsValue(funnel_info_ques.questions[ques_id]['options']['all-step-types'][active_step]['steps'][index]['fields'],3,0);
                SaveContactPreviewChanges.updateFieldsValue(funnel_info_ques.questions[ques_id]['options']['all-step-types'][active_step]['steps'][index]['fields'],0,1);

                variation_trigger = 1;
            }

            if(active_slide != index && el['field-order'].includes(checkIndexJson))
            {

                $.each(el['fields'][checkIndexJson],function(field_index,field_elem){
                    funnel_index = field_elem.value;
                    funnel_info_ques.questions[ques_id]['options']['all-step-types'][active_step]['steps'][index]['fields'][checkIndexJson][field_index].value=0;
                });
                if(funnel_index ==1)
                {
                    $.each(el['fields'][updateIndexJson],function(field_index,field_elem){

                        funnel_info_ques.questions[ques_id]['options']['all-step-types'][active_step]['steps'][index]['fields'][updateIndexJson][field_index].value=1;
                    });
                    $.each(all_steps[index]['field-order'],function (order_index,order_value){
                        if(order_value==checkIndexJson)
                        {
                            all_steps[index]['field-order'] = jQuery.grep(el['field-order'], function(value) {
                                return value != updateIndexJson;
                            });
                            all_steps[index]['field-order'][order_index] = updateIndexJson;
                        }
                    });
                    funnel_info_ques.questions[ques_id]['options']['all-step-types'][active_step]['steps'][index]['field-order'] = all_steps[index]['field-order'];
                }
            }
            setTimeout(function (){
                if(variation_trigger !== '' && variation_trigger !== undefined)
                {
                    $('.fb-options__group-clone:visible').find('select:eq(1):visible').val(variation_trigger).change();
                }
            },1200)
        });
        FunnelsUtil.saveFunnelData(funnel_info_ques);
    },


    updateFieldsValue: function (arr, step, value){
        $.each(arr[step],function (index,el){
            console.log(index,el)
            arr[step][index].value = value;
        });
    },

    findstepJsonIndex: function (step)
    {
        if(step==1)
        {
            return 0;
        }
        else if(step == 2)
        {
            return 4;
        }
        else if(step == 3)
        {
            return 5;
        }
    },

    findArrayIndex: function (step)
    {
        if(step==0)
        {
            return 1;
        }
        else if(step == 4)
        {
            return 2;
        }
        else if(step == 5)
        {
            return 3;
        }
    },


    /**
     * Get new data for dropdown by excluding already set values in parent dropdown
     * @param selectorArr
     * @param value
     * @param input_type_value
     * @returns {[]}
     */
    getDropdownNewData: function(selectorArr, value, input_type_value) {
        let newData = [];
        for (let i = 0; i <= 3; i++) {
            var item = selectorArr[i];
            if(i !== Number(value) && i !== Number(input_type_value))
            {
                newData.push(item);
            }
        }
        return newData;
    },
    getDropdownNewDataArray: function(selectorArr, value) {
        return selectorArr;
    },

    /**
     * Navigate to text-field/text-area sections
     */
    navigateContactQuestion: function () {
        $('[data-contact-nav-id]').click(function () {
            let step = $(this).data('contact-nav-id');
            $('[data-contact-form]').removeClass('step1-field step2-field step3-field').addClass('step'+step+'-field');
            SaveChangesPreview.saveJson('activesteptype', step);
            $('[data-id="active_step"]').val(step);

            if (step != 1) {
                let selectorArr = selectItems['edit-content-step2'];
                let fieldsArr = selectItems['input-type-step1'];
                let newData = null;
                let fieldsData = null;
                if (step == 2) {
                    newData = SaveContactPreviewChanges.getDropdownNewData(selectorArr, 3, -1);
                }
                let selector = 'edit-content-step3';
                $('.' + selector).select2('destroy').unbind('change').empty();
                contact_info_overlay.initCustomSelect('.' + selector, '.' + selector + '-parent', newData);
                $('.' + selector).val(1).trigger('change.select2');
                $('[data-id="active_slide"]').val(0);
            } else {
                $('[data-id="active_slide"]').val(0);
            }

            if (!SaveContactPreviewChanges.firstLoad) {
                SaveContactPreviewChanges.loadContactForm();
            }

            if (step == 2) {
                SaveContactPreviewChanges.disableAddButtonStep2();
            }

            if(step==3)
            {
                SaveContactPreviewChanges.disableAddButtonStep3();
            }
            SaveChangesPreview.updateQuickAccessLinks();
        });
    },

    disableAddButtonStep3 : function ()
    {
        $('[data-handler-slide]').find('.fb-options__group-clone').css("border-bottom", "none");
        $('[data-handler-slide]').find('.fb-modal__row_creat-group').remove();
    },

    disableAddButtonStep2 : function (data_return = false)
    {
        let current_slide_step = $('.edit-content-step3').val();
        let funnel_info = FunnelsUtil._getFunnelInfo('local_storage');
        let slide_fields = funnel_info['questions'][current_question_id]['options']['all-step-types'][1]['steps'];
        let second_slide_fields_length = null;
        let sec_step_length=0;
        let first_step_length=0;
        let existing_slide_index = [];


        let first_slide_fields_length = slide_fields[0]['fields'];
        second_slide_fields_length = slide_fields[1]['fields'];
        $.each(first_slide_fields_length,function (key,value) {
            $.each(value,function (index,columns){
                if(columns.value===1 && index !== 'last-name'){
                    first_step_length ++;
                    existing_slide_index.push(key);
                }
            })
        })
        $.each(second_slide_fields_length,function (key,value) {
            $.each(value,function (index,columns){
                if(columns.value===1 && index !== 'last-name'){
                    sec_step_length ++;
                    existing_slide_index.push(key);
                }
            })
        });
        if(parseInt(first_step_length)+parseInt(sec_step_length) >= 3)
        {
            if($('[data-organize]').css('display')=='none')
            {
                SaveContactPreviewChanges.disableAddButtonStep3();
            }
            else{
                $('[data-add-dropdown]').hide();
            }
        }
        if(data_return == true)
        {
            return existing_slide_index;
        }
    },

    /**
     * Set contact form setup text
     */
    setContactFormSetupText: function() {
        let text = '';
        let active_step = $('[data-id="active_step"]').val();
        let active_slide = $('[data-id="active_slide"]').val();

        if (active_step == 1) {
            text = 'Contact Form Setup';
        } else {
            active_slide = Number(active_slide) + 1;
            text = 'Contact Form Setup <span class="step-no-text">(Step '+active_slide+' of '+active_step+')</span>';
        }

        $('[data-contact-form-setup]').html(text);
    },

    /**
     * Load contact form on every step and edit content for dropdown
     * @param load_question_data
     */
    loadContactForm: function (load_question_data=true) {
        SaveContactPreviewChanges.renderContactForm();
        contact_info_overlay.openclose();
        contact_info_overlay.allCustomSelect('.edit-content-step3');
        if (load_question_data) {
            SaveContactPreviewChanges.loadQuestionData();
        }
        contact_info_overlay.contact_setup();
        SaveContactPreviewChanges.addRemoveDropdown();
        if (load_question_data === false) {
            $('[data-organize-save]').unbind('click');
        }
        SaveContactPreviewChanges.setSortingPopup();
        SaveContactPreviewChanges.saveSortingPopup();
        SaveContactPreviewChanges.savePhoneSettingsPopup();
        SaveContactPreviewChanges.loadPhoneSettingsClick();
    },

    /**
     * Load question data in left side
     */
    loadQuestionData: function () {
        let funnel_info = FunnelsUtil._getFunnelInfo('local_storage');
        let mappedFields = SaveContactPreviewChanges.getContactMappedFields(funnel_info, false);
        mappedFields = FunnelsUtil.getOptionsValue(mappedFields);
        if(site.env_production.toLowerCase() == "local") console.info(mappedFields);
// set question and description
        SaveContactPreviewChanges.checkboxEnableDisable(mappedFields['show-question'], 'show-question', 'question');
        SaveContactPreviewChanges.setFroalaHtml(mappedFields['question'], 'question');
        SaveContactPreviewChanges.checkboxEnableDisable(mappedFields['show-description'], 'show-description', 'description');
        SaveContactPreviewChanges.setFroalaHtml(mappedFields['description'], 'description');

// set button text and font size
        $('[data-field-name="button-text"]').val(mappedFields['button-text']);
        $('[data-silder-ranger]').bootstrapSlider('setValue', mappedFields['cta-button-settings']['font-size']);

// set button icon settings
        SaveContactPreviewChanges.checkboxEnableDisable(mappedFields['cta-button-settings']['enable-button-icon'], 'cta-button-settings.enable-button-icon', 'cta-button-settings.button-icon');
        let button_icon = mappedFields['cta-button-settings']['button-icon'];
        let button_icon_name = InputControls.obj_fontawsome[button_icon];
        if(site.env_production.toLowerCase() == "local") console.info('button-icon', button_icon, button_icon_name);
        $('[data-text-icon] .icon-wrap > i').removeClass().addClass('ico-'+button_icon);
        $('[data-text-icon] .text-icon-wrap .text-icon').html(button_icon_name);
        // $('[button-icon-color]').find('.last-selected__box').attr('style', 'background:'+mappedFields['cta-button-settings']['button-icon-color']);
        // $('[button-icon-color]').find('.last-selected__code').html(mappedFields['cta-button-settings']['button-icon-color']);
        InputControls.setIconSecurityDropdown();
        $('[data-silder-ranger-icon]').bootstrapSlider('setValue', mappedFields['cta-button-settings']['button-icon-size']);
        $('[data-field-name="cta-button-settings.enable-hide-until-answer"]').prop('checked', (mappedFields['cta-button-settings']['enable-hide-until-answer'] == 1 ? true : false));

// set security message and additional content
        SaveContactPreviewChanges.checkboxEnableDisable(mappedFields['enable-security-message'], 'enable-security-message', 'security-message-id');
        SaveContactPreviewChanges.checkboxEnableDisable(mappedFields['enable-additional-content'], 'enable-additional-content', 'additional-content');
        SaveContactPreviewChanges.setFroalaHtml(mappedFields['additional-content'], 'additional-content');

        SaveContactPreviewChanges.checkboxEnableDisable(mappedFields['enable-auto-cursor-focus'], 'enable-auto-cursor-focus');
    },

    /**
     * Check box enable disable
     * @param value
     * @param data_field_name_parent
     * @param data_field_name_child
     */
    checkboxEnableDisable: function (value, data_field_name_parent, data_field_name_child=null) {
        if (value == 1) {
            $('[data-field-name="'+data_field_name_parent+'"]').prop('checked', true);
            if (data_field_name_child !== null) $('[data-field-name="'+data_field_name_child+'"]').closest('.fb-modal__border-row').show();
        } else {
            $('[data-field-name="'+data_field_name_parent+'"]').prop('checked', false);
            if (data_field_name_child !== null) $('[data-field-name="'+data_field_name_child+'"]').closest('.fb-modal__border-row').hide();
        }
    },

    /**
     * Set Froala editor html
     * @param value
     * @param data_field_name
     */
    setFroalaHtml: function (value, data_field_name) {
        $('[data-field-name="'+data_field_name+'"]').find('.fr-element.fr-view').html(value);
    },
};

jQuery(document).ready(function() {
    contact_info_overlay.init();

// load 2/3 step if user selected
    let active_step = $('[data-id="active_step"]').val();
    $('[data-contact-nav-id="'+active_step+'"]').click();
    setTimeout(function () {
        SaveContactPreviewChanges.firstLoad = false;
    }, 500);

    FBEditor.init();
    InputControls.init();
    FunnelActions.saveFunnelInDB();
    InputControls.setIconSecurityDropdown();
});
